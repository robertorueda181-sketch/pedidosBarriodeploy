import{a as x}from"./chunk-QXEN7B67.js";import{c as V}from"./chunk-7C7BYA4G.js";import{c as z}from"./chunk-N5S4MXVG.js";import{C as N,G as g,M as m,U as h,V as D,X as b,Xa as O,Ya as A,Z as l,a as p,ga as U,hb as L,ib as C,l as d,m as w,ma as f,n as S,s as y,ta as P}from"./chunk-7543YNFF.js";var v=class{constructor(){}loadScript(e,c,t,s=null){if(typeof document<"u"&&!document.getElementById(e)){let i=document.createElement("script");i.async=!0,i.src=c,i.onload=t,s||(s=document.head),s.appendChild(i)}}},R=class{constructor(){}},E=()=>typeof window.google?.accounts<"u",K=()=>{if(!E())throw new Error("Google Accounts API is undefined")},I=()=>(K(),window.google.accounts),G={oneTapEnabled:!0},_=(()=>{let e=class e extends v{constructor(t,s){super(),this.clientId=t,this.initOptions=s,this.changeUser=new O,this._socialUser=new d(null),this._accessToken=new d(null),this._receivedAccessToken=new O,this.initOptions=p(p({},G),this.initOptions),this._socialUser.pipe(m(1)).subscribe(this.changeUser),this._accessToken.pipe(m(1)).subscribe(this._receivedAccessToken)}initialize(t,s){return new Promise((i,r)=>{try{this.loadScript(e.PROVIDER_ID,this.getGoogleLoginScriptSrc(s||""),()=>{if(E()){if(google.accounts.id.initialize({client_id:this.clientId,auto_select:t,callback:({credential:n})=>{let a=this.createSocialUser(n);this._socialUser.next(a)},prompt_parent_id:this.initOptions?.prompt_parent_id,itp_support:this.initOptions.oneTapEnabled,use_fedcm_for_prompt:this.initOptions.oneTapEnabled}),this.initOptions.oneTapEnabled&&this._socialUser.pipe(N(n=>n===null)).subscribe(()=>google.accounts.id.prompt(console.debug)),this.initOptions.scopes){let n=this.initOptions.scopes instanceof Array?this.initOptions.scopes.filter(a=>a).join(" "):this.initOptions.scopes;this._tokenClient=google.accounts.oauth2.initTokenClient({client_id:this.clientId,scope:n,prompt:this.initOptions.prompt,callback:a=>{a.error?this._accessToken.error({code:a.error,description:a.error_description,uri:a.error_uri}):this._accessToken.next(a.access_token)}})}i()}})}catch(n){r(n)}})}getLoginStatus(){return new Promise((t,s)=>{this._socialUser.value?t(this._socialUser.value):s(`No user is currently logged in with ${e.PROVIDER_ID}`)})}refreshToken(){return new Promise((t,s)=>{I().id.revoke(this._socialUser.value.id,i=>{i.error?s(i.error):t(this._socialUser.value)})})}getAccessToken(){return new Promise((t,s)=>{this._tokenClient?(this._tokenClient.requestAccessToken({hint:this._socialUser.value?.email}),this._receivedAccessToken.pipe(g(1)).subscribe(t)):this._socialUser.value?s("No token client was instantiated, you should specify some scopes."):s("You should be logged-in first.")})}revokeAccessToken(){return new Promise((t,s)=>{this._tokenClient?this._accessToken.value?I().oauth2.revoke(this._accessToken.value,()=>{this._accessToken.next(null),t()}):s("No access token to revoke"):s("No token client was instantiated, you should specify some scopes.")})}signIn(){return Promise.reject('You should not call this method directly for Google, use "<asl-google-signin-button>" wrapper or generate the button yourself with "google.accounts.id.renderButton()" (https://developers.google.com/identity/gsi/web/guides/display-button#javascript)')}async signOut(){I().id.disableAutoSelect(),this._socialUser.next(null)}createSocialUser(t){let s=new R;s.idToken=t;let i=this.decodeJwt(t);return s.id=i.sub,s.name=i.name,s.email=i.email,s.photoUrl=i.picture,s.firstName=i.given_name,s.lastName=i.family_name,s}decodeJwt(t){let i=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(i).split("").map(function(n){return"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(r)}getGoogleLoginScriptSrc(t){return t?`https://accounts.google.com/gsi/client?hl=${t}`:"https://accounts.google.com/gsi/client"}};e.PROVIDER_ID="GOOGLE";let o=e;return o})(),$=new b("SocialAuthServiceConfig"),T=(()=>{let e=class e{get authState(){return this._authState.asObservable()}get initState(){return this._initState.asObservable()}constructor(){this.providers=new Map,this.autoLogin=!1,this.lang="",this._user=null,this._authState=new w(1),this.initialized=!1,this._initState=new S,this._ngZone=l(A),this._injector=l(U),this._config=l($),Promise.resolve(this._config).then(t=>this.initialize(t))}initialize(t){this.autoLogin=t.autoLogin!==void 0?t.autoLogin:!1,this.lang=t.lang!==void 0?t.lang:"";let{onError:s=console.error}=t;t.providers.forEach(i=>{this.providers.set(i.id,"prototype"in i.provider?this._injector.get(i.provider):i.provider)}),Promise.all(Array.from(this.providers.values()).map(i=>i.initialize(this.autoLogin,this.lang))).then(()=>{if(this.autoLogin){let i=[],r=!1;this.providers.forEach((n,a)=>{let k=n.getLoginStatus();i.push(k),k.then(j=>{this.setUser(j,a),r=!0}).catch(console.debug)}),Promise.all(i).catch(()=>{r||(this._user=null,this._authState.next(null))})}this.providers.forEach((i,r)=>{y(i.changeUser)&&i.changeUser.subscribe(n=>{this._ngZone.run(()=>{this.setUser(n,r)})})})}).catch(i=>{s(i)}).finally(()=>{this.initialized=!0,this._initState.next(this.initialized),this._initState.complete()})}async getAccessToken(t){let s=this.providers.get(t);if(this.initialized)if(s){if(!(s instanceof _))throw e.ERR_NOT_SUPPORTED_FOR_ACCESS_TOKEN}else throw e.ERR_LOGIN_PROVIDER_NOT_FOUND;else throw e.ERR_NOT_INITIALIZED;return await s.getAccessToken()}refreshAuthToken(t){return new Promise((s,i)=>{if(!this.initialized)i(e.ERR_NOT_INITIALIZED);else{let r=this.providers.get(t);r?typeof r.refreshToken!="function"?i(e.ERR_NOT_SUPPORTED_FOR_REFRESH_TOKEN):r.refreshToken().then(n=>{this.setUser(n,t),s()}).catch(n=>{i(n)}):i(e.ERR_LOGIN_PROVIDER_NOT_FOUND)}})}refreshAccessToken(t){return new Promise((s,i)=>{if(!this.initialized)i(e.ERR_NOT_INITIALIZED);else if(t!==_.PROVIDER_ID)i(e.ERR_NOT_SUPPORTED_FOR_REFRESH_TOKEN);else{let r=this.providers.get(t);r instanceof _?r.revokeAccessToken().then(s).catch(i):i(e.ERR_LOGIN_PROVIDER_NOT_FOUND)}})}signIn(t,s){return new Promise((i,r)=>{if(!this.initialized)r(e.ERR_NOT_INITIALIZED);else{let n=this.providers.get(t);n?n.signIn(s).then(a=>{this.setUser(a,t),i(a)}).catch(a=>{r(a)}):r(e.ERR_LOGIN_PROVIDER_NOT_FOUND)}})}signOut(t=!1){return new Promise((s,i)=>{if(!this.initialized)i(e.ERR_NOT_INITIALIZED);else if(!this._user)i(e.ERR_NOT_LOGGED_IN);else{let r=this._user.provider,n=this.providers.get(r);n?n.signOut(t).then(()=>{s(),this.setUser(null)}).catch(a=>{i(a)}):i(e.ERR_LOGIN_PROVIDER_NOT_FOUND)}})}setUser(t,s){t&&s&&(t.provider=s),this._user=t,this._authState.next(t)}};e.ERR_LOGIN_PROVIDER_NOT_FOUND="Login provider not found",e.ERR_NOT_LOGGED_IN="Not logged in",e.ERR_NOT_INITIALIZED="Login providers not ready yet. Are there errors on your console?",e.ERR_NOT_SUPPORTED_FOR_REFRESH_TOKEN="Chosen login provider is not supported for refreshing a token",e.ERR_NOT_SUPPORTED_FOR_ACCESS_TOKEN="Chosen login provider is not supported for getting an access token",e.\u0275fac=function(s){return new(s||e)},e.\u0275prov=h({token:e,factory:e.\u0275fac,providedIn:"root"});let o=e;return o})();var Q=(()=>{let e=class e{constructor(){this.type="icon",this.size="medium",this.text="signin_with",this.shape="rectangular",this.theme="outline",this.logo_alignment="left",this.width=0,this.locale="";let t=l(P);l(T).initState.pipe(g(1)).subscribe(()=>{Promise.resolve(this.width).then(i=>{i>400||i<200&&i!=0?Promise.reject("Please note .. max-width 400 , min-width 200 (https://developers.google.com/identity/gsi/web/tools/configurator)"):E()&&google.accounts.id.renderButton(t.nativeElement,{type:this.type,size:this.size,text:this.text,width:this.width,shape:this.shape,theme:this.theme,logo_alignment:this.logo_alignment,locale:this.locale})})})}};e.\u0275fac=function(s){return new(s||e)},e.\u0275dir=C({type:e,selectors:[["asl-google-signin-button"]],inputs:{type:"type",size:"size",text:"text",shape:"shape",theme:"theme",logo_alignment:"logo_alignment",width:"width",locale:"locale"}});let o=e;return o})(),W=(()=>{let e=class e{};e.\u0275fac=function(s){return new(s||e)},e.\u0275mod=L({type:e}),e.\u0275inj=D({});let o=e;return o})();var u=class o{http=l(z);appConfigService=l(x);get apiUrl(){return this.appConfigService.apiUrl+"/register"}registerBusiness(e){return this.http.post(this.apiUrl,e)}registerSocialUser(e){return this.http.post(`${this.appConfigService.apiUrl}/auth/social-register`,e)}getCategories(e,c=""){return this.http.get(`${this.appConfigService.apiUrl}/Tipos?tipo=${e}&param=${c}`)}reverseGeocode(e,c){return this.http.get(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${c}&zoom=18&addressdetails=1`)}static \u0275fac=function(c){return new(c||o)};static \u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"})};var F=class o{socialAuthService=l(T);router=l(V);registerService=l(u);TOKEN_KEY="auth_token";USER_KEY="user_data";user=f(null);loggedIn=f(!1);constructor(){this.checkExistingSession(),this.socialAuthService.authState.subscribe(e=>{this.user.set(e),this.loggedIn.set(e!=null),e?(console.log("User logged in:",e),this.registerSocialUser(e)):this.clearSession()})}signOut(){this.socialAuthService.signOut(),this.clearSession(),this.router.navigate(["/login"])}getToken(){return localStorage.getItem(this.TOKEN_KEY)}isAuthenticated(){let e=this.getToken();if(!e)return!1;try{let t=JSON.parse(atob(e.split(".")[1])).exp*1e3;return Date.now()<t}catch{return!1}}checkExistingSession(){let e=this.getToken(),c=localStorage.getItem(this.USER_KEY);if(e&&c&&this.isAuthenticated())try{let t=JSON.parse(c);this.user.set(t),this.loggedIn.set(!0)}catch(t){console.error("Error parsing stored user data:",t),this.clearSession()}}saveSession(e,c){localStorage.setItem(this.TOKEN_KEY,e),localStorage.setItem(this.USER_KEY,JSON.stringify(c))}clearSession(){localStorage.removeItem(this.TOKEN_KEY),localStorage.removeItem(this.USER_KEY),this.user.set(null),this.loggedIn.set(!1)}registerSocialUser(e){if(!e.id||!e.email){console.error("User data incomplete:",e);return}let c={id:e.id,email:e.email,firstName:e.firstName||"",lastName:e.lastName||"",provider:e.provider||"google",idToken:e.idToken||""};this.registerService.registerSocialUser(c).subscribe({next:t=>{console.log("User registered/authenticated successfully:",t),t.token?(this.saveSession(t.token,e),console.log("Session saved successfully")):console.warn("No token received from backend")},error:t=>{console.error("Error registering/authenticating user:",t)}})}static \u0275fac=function(c){return new(c||o)};static \u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"})};export{_ as a,$ as b,Q as c,W as d,u as e,F as f};
